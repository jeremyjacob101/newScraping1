name: Daily Sweep

on:
  schedule:
    # 4 AM Israel time = 2 AM UTC (Israel is UTC+2, no DST at 4am winter)
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  clear-old-showtimes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: clear-old-showtimes
      cancel-in-progress: false
    env:
      TZ: Asia/Jerusalem
      LOG_LEVEL: ERROR
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache .venv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-

      - name: Create venv and install deps (debug)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.debug || 'false' }}" = "true" ]; then set -x; fi

          echo "=== System ==="
          uname -a || true
          lsb_release -a || true
          echo "PWD: $PWD"
          ls -la

          echo "=== Python (pre-venv) ==="
          which python || true
          python --version || true
          python -c "import sys; print('sys.executable:', sys.executable); print('sys.version:', sys.version)" || true

          echo "=== Remove any existing venv (avoid broken cached venv) ==="
          rm -rf .venv

          echo "=== Create venv ==="
          python -m venv .venv

          echo "=== Inspect venv bin dir ==="
          ls -la .venv/bin || true

          echo "=== Activate venv ==="
          . .venv/bin/activate

          echo "=== Python/Pip (inside venv) ==="
          echo "which python: $(which python)"
          python --version
          python -c "import sys; print('sys.executable:', sys.executable)"

          echo "which pip: $(which pip || true)"
          ls -la .venv/bin/pip* || true
          file .venv/bin/pip || true
          head -n 3 .venv/bin/pip || true
          readlink -f .venv/bin/pip || true

          echo "=== Upgrade pip using python -m pip (bypasses broken pip launcher) ==="
          python -m pip install --upgrade pip
          python -m pip --version

          echo "=== Install deps ==="
          if [ -f requirements.txt ]; then
            echo "Installing from requirements.txt"
            python -m pip install --prefer-binary -r requirements.txt
          elif [ -f pyproject.toml ]; then
            echo "Installing from pyproject.toml"
            python -m pip install --prefer-binary .
          else
            echo "No requirements.txt or pyproject.toml found" >&2
            exit 1
          fi

          echo "=== Verify python-dotenv import ==="
          python -c "import dotenv; from dotenv import load_dotenv; print('python-dotenv OK:', dotenv.__version__)"

      - name: Debug env vars
        run: |
          echo "SUPABASE_URL: $SUPABASE_URL"
          echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:+set}"

      - name: Run cleanup script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e
          . .venv/bin/activate
          export PYTHONPATH="${PYTHONPATH}:${{ github.workspace }}"
          python backend/utils/supabase/clear_old_entries.py ${{ github.event.inputs.args }}