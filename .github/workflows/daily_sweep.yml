name: Daily Sweep

on:
  schedule:
    - cron: "0 2 * * *"  # UTC
  workflow_dispatch:
    inputs:
      args:
        description: "Arguments to pass (optional)"
        required: false
        default: ""

jobs:
  clear-old-showtimes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: clear-old-showtimes
      cancel-in-progress: false
    env:
      TZ: Asia/Jerusalem
      LOG_LEVEL: ERROR
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14.2"

      - name: Cache .venv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-

      - name: Create venv and install deps
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements.txt

      - name: Run cleanup script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e
          . .venv/bin/activate
          export PYTHONPATH="${PYTHONPATH}:${{ github.workspace }}"
          python backend/utils/supabase/clear_old_entries.py
